# 缓存指南

emst 使用本地缓存系统存储K线数据，减少API调用并提高性能。

## 概述

缓存数据存储在 `.emst/cache/` 目录中，结构如下：

```
.emst/cache/
  ├── 688005_1_daily_fqt1.json
  ├── 688005_1_weekly_fqt1.json
  ├── 688005_1_daily_fqt0.json
  ├── 688005_1_daily_fqt2.json
  ├── 000001_0_daily_fqt1.json
  └── ...
```

文件命名格式：`{code}_{market}_{timeframe}_fqt{fqt}.json`

其中 `fqt` 表示复权类型：
- `fqt0`: 不复权
- `fqt1`: 前复权（默认）
- `fqt2`: 后复权

不同复权类型的数据会分开缓存，互不影响。

## 缓存文件格式

每个缓存文件包含：

```json
{
  "data": [
    {
      "date": "2024-01-01",
      "open": 100.0,
      "close": 105.0,
      "high": 106.0,
      "low": 99.0,
      "volume": 1000000,
      "amount": 105000000
    }
  ],
  "lastSync": 1704067200000,
  "metadata": {
    "symbol": "688005",
    "market": 1,
    "timeframe": "daily",
    "fqt": 1
  }
}
```

### 字段说明

- `data`: K线记录数组
- `lastSync`: 最后同步时间戳（自纪元以来的毫秒数）
- `metadata`: 缓存元数据（股票代码、市场、时间周期、复权类型）
  - `symbol`: 股票代码
  - `market`: 市场代码
  - `timeframe`: 时间周期
  - `fqt`: 复权类型（0=不复权，1=前复权，2=后复权）

## 缓存行为

### 自动缓存

获取数据时：
1. 数据自动保存到缓存
2. 获取前检查缓存
3. 过期缓存自动刷新

### 缓存有效性

缓存被认为有效，如果：
- 缓存文件存在
- 缓存不超过24小时（默认）
- 缓存覆盖请求的日期范围

### 增量更新

同步时：
1. 检查现有缓存的日期范围
2. 仅获取上次缓存日期之后的数据
3. 将新数据与现有缓存合并
4. 避免重复记录

## 缓存管理

### 使用缓存

默认启用缓存。获取数据时：

```bash
# 如果缓存可用且有效则使用缓存
emst stock fetch --code 688005

# 绕过缓存
emst stock fetch --code 688005 --no-cache
```

### 获取时的缓存

当不使用 `--no-cache` 时：
1. 检查缓存有效性
2. 检查缓存是否覆盖请求的日期范围
3. 如果有效且完整，返回缓存数据
4. 如果过期或不完整，获取新数据并更新缓存
5. 返回数据

### 手动缓存管理

您可以手动管理缓存文件：

```bash
# 查看缓存文件
ls .emst/cache/

# 查看特定缓存文件（前复权，默认）
cat .emst/cache/688005_1_daily_fqt1.json

# 查看不复权缓存文件
cat .emst/cache/688005_1_daily_fqt0.json

# 查看后复权缓存文件
cat .emst/cache/688005_1_daily_fqt2.json

# 删除特定复权类型的缓存文件
rm .emst/cache/688005_1_daily_fqt1.json

# 清除所有缓存
rm -rf .emst/cache/*
```

## 缓存策略

### 日线同步

对于日线数据，缓存通常有效期为24小时：

```bash
# 同步日线数据（缓存有效24小时）
emst stock watchlist sync --timeframe daily
```

### 日内数据

对于日内数据（5分钟、15分钟等），缓存有效性取决于您的需求：

```bash
# 同步5分钟数据（可能需要更频繁的更新）
emst stock watchlist sync --timeframe 5min --force
```

### 历史数据

对于历史数据，缓存可以保存更长时间：

```bash
# 同步历史数据（缓存可以无限期保存）
emst stock watchlist sync --start 20200101 --end 20231231
```

## 性能考虑

### 缓存大小

- 每个缓存文件存储一个股票/市场/时间周期的数据
- 大日期范围会导致更大的缓存文件
- 考虑定期清除旧缓存文件

### 缓存效率

- 首次获取：完整API调用
- 后续获取：如果缓存有效则使用缓存
- 增量同步：仅获取新数据

### 网络使用

- 缓存显著减少API调用
- 增量同步最小化数据传输
- 谨慎使用 `--force` 以避免不必要的API调用

## 故障排除

### 过期缓存

如果您怀疑数据过期：

```bash
# 强制刷新
emst stock watchlist sync --force
```

### 缓存损坏

如果缓存文件损坏：

```bash
# 删除特定缓存文件（需要指定复权类型）
rm .emst/cache/{code}_{market}_{timeframe}_fqt{fqt}.json
# 例如：
rm .emst/cache/688005_1_daily_fqt1.json

# 或清除所有缓存
rm -rf .emst/cache/*
```

### 缓存不工作

如果缓存似乎不工作：
1. 检查 `.emst/cache/` 目录是否存在
2. 验证文件权限
3. 检查磁盘空间
4. 尝试清除缓存并重新获取

## 高级用法

### 自定义缓存位置

目前，缓存存储在项目目录的相对路径 `.emst/cache/` 中。要更改位置，需要修改缓存模块。

### 缓存过期

默认缓存过期时间为24小时。这是硬编码的，但可以在缓存模块中修改。

### 缓存合并

获取新数据时，会与现有缓存合并：
- 避免重复（按日期）
- 数据按日期排序
- 新数据优先于旧数据
